<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vehicle Rental System â€” Aesthetic Demo (custom palette)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
	 :root{
	 	/* Palette provided by user */
	 	--p1: #27391C; /* primary darker sage */
	 	--p2: #483AA0; /* primary lighter */
	 	--p3: #0E2148; /* surface / card */
	 	--p4: #7965C1; /* page background */
	 	--accent: var(--p1);
	 	--accent-2: var(--p2);
	 	--bg: linear-gradient(180deg, var(--p4) 0%, var(--p3) 100%);
	 	--surface: rgba(255,255,255,0.6);
	 	--muted: #506053;
	 	--border: rgba(16,32,24,0.06);
	 	--radius: 14px;
	 	--card-shadow: 0 6px 18px rgba(25,40,30,0.06);
	 	--glass-border: rgba(16,32,24,0.06);
	 	--text: #102017;
	 }
	 *{box-sizing:border-box}
	 html,body{height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
	 a{color:var(--accent)}
	 .app{max-width:1200px; margin:28px auto; padding:22px; display:grid; grid-template-columns:260px 1fr; gap:18px;}
	 .sidebar{
	 	background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.82));
	 	border-radius:var(--radius); padding:18px; box-shadow:var(--card-shadow);
	 	border:1px solid var(--glass-border); height:calc(100vh - 56px); position:sticky; top:28px; overflow:auto;
	 }
	 .brand{display:flex; gap:10px; align-items:center; margin-bottom:14px}
	 .logo{
	 	width:46px; height:46px; border-radius:10px;
	 	background: linear-gradient(135deg, var(--p1), var(--p2));
	 	display:flex; align-items:center; justify-content:center; font-weight:800; color: #f7fbf7;
	 	box-shadow: 0 6px 18px rgba(25,40,30,0.06);
	 }
	 .brand h2{font-size:16px; margin:0; color:var(--text)}
	 .brand p{margin:0; color:var(--muted); font-size:12px}
	 nav button{
	 	width:100%; display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px;
	 	background:transparent; border:0; color:var(--muted); cursor:pointer; margin-bottom:8px; font-weight:600;
	 }
	 nav button.active{
	 	background: linear-gradient(90deg, rgba(129,154,145,0.12), rgba(167,193,168,0.06));
	 	color:var(--p1);
	 }
	 .quick{margin-top:12px; display:flex; gap:8px; flex-wrap:wrap}
	 .btn{
	 	background: linear-gradient(90deg,var(--p1), var(--p2));
	 	color:#f7fbf7; padding:8px 12px; border-radius:10px; border:0; cursor:pointer;
	 	box-shadow: 0 6px 18px rgba(129,154,145,0.08); font-weight:600;
	 }
	 .btn.ghost{
	 	background:transparent; color:var(--p1); border:1px solid rgba(25,40,30,0.04); box-shadow:none;
	 }
	 .tiny{font-size:12px; color:var(--muted)}
	 .main{
	 	min-height:80vh; border-radius:var(--radius); padding:18px;
	 	background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.86));
	 	border:1px solid var(--glass-border); box-shadow:var(--card-shadow);
	 }
	 .topbar{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px}
	 .search{
	 	display:flex; align-items:center; gap:8px; background:rgba(16,32,24,0.03); padding:8px 10px; border-radius:10px; color:var(--muted);
	 }
	 .search input{background:transparent; border:0; outline:none; color:var(--text); width:220px}
	 .cards{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:16px}
	 .card{
	 	background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.92));
	 	padding:14px; border-radius:12px; border:1px solid var(--border);
	 }
	 .card h3{margin:0; font-size:13px; color:var(--muted)}
	 .card .num{font-weight:800; font-size:20px; margin-top:8px; color:var(--text)}
	 .panel{
	 	background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
	 	border-radius:12px; padding:12px; border:1px solid var(--border);
	 }
	 table{width:100%; border-collapse:collapse; font-size:14px; color:var(--text)}
	 th,td{padding:12px 10px; text-align:left; border-bottom:1px dashed rgba(16,32,24,0.03)}
	 th{color:var(--muted); font-weight:700; font-size:13px}
	 .muted{color:var(--muted)}
	 .badge{
	 	padding:6px 10px; border-radius:999px; font-size:13px;
	 	background: linear-gradient(90deg, rgba(129,154,145,0.08), rgba(167,193,168,0.04));
	 	border:1px solid rgba(16,32,24,0.03); color:var(--p1);
	 }
	 .pill{padding:6px 10px; border-radius:999px; font-size:12px; background:rgba(16,32,24,0.05); color:var(--muted)}
	 .modal-backdrop{position:fixed; inset:0; background:rgba(16,32,24,0.35); display:flex; align-items:center; justify-content:center; z-index:60}
	 /* Modal: fixed height, scrollable body + sticky footer */
	 .modal{
	 	width:880px; max-width:95%;
	 	max-height:90vh;
	 	display:flex; flex-direction:column;
	 	background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
	 	border-radius:12px; border:1px solid var(--border);
	 	padding:0; box-sizing:border-box;
	 }
	 .modal-body{
	 	padding:18px; overflow:auto; -webkit-overflow-scrolling:touch;
	 }
	 .modal-footer{
	 	display:flex; justify-content:flex-end; gap:8px; padding:12px 18px;
	 	border-top:1px solid rgba(16,32,24,0.03); background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.98));
	 	position:sticky; bottom:0; z-index:10; box-shadow:0 -6px 12px rgba(16,32,24,0.02);
	 }
	 .form-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
	 input,select,textarea{
	 	width:100%; padding:10px; border-radius:8px; border:1px solid rgba(16,32,24,0.06);
	 	background:transparent; color:var(--text)
	 }
	 label{font-size:13px; color:var(--muted); margin-bottom:6px; display:block}
	 .form-row{margin-bottom:10px}
	 .thumb{width:84px; height:56px; border-radius:8px; object-fit:cover; border:1px solid rgba(16,32,24,0.06)}
	 .doc-list{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
	 .doc-item{display:flex; gap:8px; align-items:center; background:rgba(16,32,24,0.02); padding:6px 8px; border-radius:8px; font-size:13px; color:var(--muted)}
	 @media (max-width:980px){ .app{grid-template-columns:1fr; padding:12px} .cards{grid-template-columns:repeat(2,1fr)} .form-grid{grid-template-columns:1fr} .search input{width:140px} }
	 @media (max-width:640px){ .cards{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="app">
	<aside class="sidebar">
		<div class="brand">
			<div class="logo">R</div>
			<div>
				<h2>	 RYDON</h2>
				<p class="tiny">Manage vehicles, customers, bookings & charges</p>
			</div>
		</div>
		<nav id="menu">
            <button onclick="goBack()" style="color:var(--p2); margin-bottom:12px; background:linear-gradient(90deg, rgba(129,154,145,0.12), rgba(167,193,168,0.06));">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Go Back
            </button>
            <button data-view="dashboard" class="active">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.9"><path d="M3 13h8V3H3v10zM3 21h8v-6H3v6zM13 21h8V11h-8v10zM13 3v6h8V3h-8z" fill="currentColor" /></svg>
				Dashboard
			</button>
			<button data-view="vehicles">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 13v-2l3-6h10l3 6v2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
				Vehicles
			</button>
			<button data-view="customers">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm-9 9v-1a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v1" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
				Customers
			</button>
			<button data-view="bookings">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 10V7a2 2 0 0 0-2-2h-3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
				Bookings
			</button>
			<button data-view="maintenance">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M22 12l-4-2-1 2-2 1 1 2-2 1-2 3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
				Maintenance
			</button>
		</nav>
		<div style="margin-top:14px">
			<div class="tiny">Quick actions</div>
			<div class="quick" style="margin-top:8px">
				<button id="addVehicleBtn" class="btn">+ Vehicle</button>
				<button id="addCustomerBtn" class="btn" style="background:linear-gradient(90deg,var(--p2),var(--p3))">+ Customer</button>
			</div>
		</div>
	</aside>
	<main class="main">
		<div class="topbar">
			<div style="display:flex; gap:12px; align-items:center">
				<div class="search">
					<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
					<input id="globalSearch" placeholder="Search registrations, customers, bookings..." />
				</div>
				<div class="tiny muted">Filter: <span id="filterInfo">All</span></div>
			</div>
			<div style="display:flex; gap:10px; align-items:center">
				<button id="exportBtn" class="btn btn-ghost" style="background:transparent; border:1px solid var(--glass-border); color:var(--muted)">Export</button>
				<button id="resetBtn" class="btn ghost">Reset</button>
			</div>
		</div>
		<div class="cards" id="cardsArea">
			<div class="card panel">
				<h3>Vehicles</h3>
				<div class="num" id="statVehicles">0</div>
				<div class="tiny muted">Total vehicles in fleet</div>
			</div>
			<div class="card panel">
				<h3>Customers</h3>
				<div class="num" id="statCustomers">0</div>
				<div class="tiny muted">Registered customers</div>
			</div>
			<div class="card panel">
				<h3>Active / Booked</h3>
				<div class="num" id="statBookings">0</div>
				<div class="tiny muted">Ongoing or upcoming bookings</div>
			</div>
		</div>
		<section id="contentArea"></section>
	</main>
</div>
<div id="modalRoot" style="display:none"></div>

<script>
/* =========================
	 Vehicle Rental System â€” Aesthetic Demo with vehicle docs + driver option
	 + modal fixed (scrollable body + sticky footer)
	 + vehicle type (Car / Bike) and filter in booking
	 Single-file (HTML + CSS + JS)
	 ========================= */
// ---------- state & storage ----------
const storageKey = 'vrs_docs_driver_theme_v2';
const state = { vehicles: [], customers: [], bookings: [], maintenance: [], view: 'dashboard' };
// helpers
const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
const save = () => localStorage.setItem(storageKey, JSON.stringify(state));
const load = () => {
	const raw = localStorage.getItem(storageKey);
	if(raw){ try{ const parsed = JSON.parse(raw); Object.assign(state, parsed); }catch(e){ console.error(e) } }
};
const fmt = d => d ? new Date(d).toLocaleString() : '';
function ceilDays(start, end){
	const ms = new Date(end) - new Date(start);
	if(isNaN(ms)) return 0;
	return Math.max(1, Math.ceil(ms / (1000*60*60*24)));
}
function clamp(n){ return Number.isFinite(n) ? n : 0; }
// ---------- seed ----------
function seed(){
	if(state.vehicles.length) return;
	
	// --- Data URL placeholders for the initial vehicles ---
	const hondaCityPhoto = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAD/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAAAAAAAAAAAAAAAAAAAAAF//EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwAAhEDEQA/ALgAf/9k='; // Dummy 1x1 white image
	const tataTiagoPhoto = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAf/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAAAAAAAAAAAAAAAAAAAAAF//EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwAAhEDEQA/ALgAf/9k='; // Dummy 1x1 white image
	const hondaCBRPhoto = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAj/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAAAAAAAAAAAAAAAAAAAAAF//EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwAAhEDEQA/ALgAf/9k='; // Dummy 1x1 white image

	state.vehicles = [
		{id:uid('v'), reg:'KL-14-GH-9876', type:'Car', make:'Honda', model:'City VX', year:2020, odometer:56400, ratePerDay:1800, perKmRate:11, status:'available', notes:'', photo:hondaCityPhoto, insured:false, insuranceExpiry:null, pollutionTested:false, pollutionExpiry:null},
		{id:uid('v'), reg:'KL-15-JK-2468', type:'Car', make:'Tata', model:'Tiago XZ', year:2021, odometer:27900, ratePerDay:1000, perKmRate:8, status:'available', notes:'', photo:tataTiagoPhoto, insured:true, insuranceExpiry:new Date(Date.now()+1000*60*60*24*180).toISOString(), pollutionTested:true, pollutionExpiry:new Date(Date.now()+1000*60*60*24*365).toISOString()},
		{id:uid('v'), reg:'KL-01-VH-9001', type:'Bike', make:'Honda', model:'CB Shine', year:2020, odometer:12000, ratePerDay:400, perKmRate:2, status:'available', notes:'', photo:hondaCBRPhoto, insured:true, insuranceExpiry:new Date(Date.now()+1000*60*60*24*120).toISOString(), pollutionTested:false, pollutionExpiry:null}
	];
	state.customers = [
		{id:uid('c'), name:'Priya Joshi', phone:'9876543210', email:'priya@example.com'},
		{id:uid('c'), name:'Rohit Verma', phone:'9123456780', email:'rohit@example.com'}
	];
	const now = new Date();
	const later = new Date(now.getTime() + 1000*60*60*24*1.5); // +1.5 days
	state.bookings = [
		{id:uid('b'), customerId: state.customers[0].id, vehicleId: state.vehicles[0].id, start: now.toISOString(), end: later.toISOString(), startOdometer: state.vehicles[0].odometer, endOdometer: null, status:'booked', createdAt: now.toISOString(), totalCharge: null, needsDriver: false}
	];
	state.maintenance = [
		{id:uid('m'), vehicleId: state.vehicles[1].id, date: new Date().toISOString(), type:'Engine service', vendor:'AutoCare', cost:4200, notes:'Periodic service'}
	];
	save();
}

// ---------- UI wiring ----------
const menu = document.getElementById('menu');
const contentArea = document.getElementById('contentArea');
const modalRoot = document.getElementById('modalRoot');
const globalSearch = document.getElementById('globalSearch');
const filterInfo = document.getElementById('filterInfo');

menu.addEventListener('click', e => {
	if(e.target.tagName === 'BUTTON') {
		const view = e.target.dataset.view;
		setView(view);
	}
});

// quick actions
document.getElementById('addVehicleBtn').onclick = () => { setView('vehicles'); setTimeout(()=>openVehicleModal(),60); };
document.getElementById('addCustomerBtn').onclick = () => { setView('customers'); setTimeout(()=>openCustomerModal(),60); };
document.getElementById('exportBtn').onclick = () => exportCSV('all');
document.getElementById('resetBtn').onclick = ()=>{ if(confirm('Clear demo data?')) { localStorage.removeItem(storageKey); location.reload(); } };
globalSearch.addEventListener('input', () => renderCurrent() );

// navigation
function setView(v){
	state.view = v;
	document.querySelectorAll('#menu button').forEach(b => b.classList.toggle('active', b.dataset.view === v));
	renderCurrent();
}

// ---------- Rendering ----------
function renderStats(){
	document.getElementById('statVehicles').textContent = state.vehicles.length;
	document.getElementById('statCustomers').textContent = state.customers.length;
	document.getElementById('statBookings').textContent = state.bookings.filter(b=>b.status!=='cancelled' && b.status!=='completed').length;
}

function renderCurrent(){
	renderStats();
	if(state.view === 'dashboard') renderDashboard();
	else if(state.view === 'vehicles') renderVehicles();
	else if(state.view === 'customers') renderCustomers();
	else if(state.view === 'bookings') renderBookings();
	else if(state.view === 'maintenance') renderMaintenance();
}

// DASHBOARD
function renderDashboard(){
	filterInfo.textContent = 'All';
	const booked = state.bookings.filter(b => b.status === 'booked' || b.status === 'active');
	contentArea.innerHTML = `
		<div class="panel" style="margin-bottom:12px; display:flex; gap:12px; align-items:center; justify-content:space-between;">
			<div>
				<h2 style="margin:0 0 8px 0">Welcome â€” Vehicle Rental System</h2>
				<div class="tiny muted">Manage fleet, customers, bookings and calculate charges at return.</div>
			</div>
			<div style="text-align:right">
				<div class="tiny muted">Today</div>
				<div style="font-weight:800; font-size:18px">${new Date().toLocaleDateString()}</div>
			</div>
		</div>

		<div style="display:grid; grid-template-columns: 1fr 480px; gap:12px;">
			<div class="panel">
				<h3 style="margin-top:0">Upcoming & Active Bookings</h3>
				<table>
					<thead><tr><th>Vehicle</th><th>Customer</th><th>From</th><th>To</th><th>Status</th></tr></thead>
					<tbody>
						${state.bookings.slice().sort((a,b)=>new Date(a.start)-new Date(b.start)).map(b=>{
							const v = state.vehicles.find(x=>x.id===b.vehicleId) || {};
							const c = state.customers.find(x=>x.id===b.customerId) || {};
							return `<tr>
								<td><strong>${v.reg||'â€”'}</strong><div class="tiny muted">${v.make||''} ${v.model||''}</div></td>
								<td>${c.name||'â€”'}<div class="tiny muted">${c.phone||''}</div></td>
								<td>${fmt(b.start)}</td>
								<td>${fmt(b.end)}</td>
								<td><span class="badge">${b.status}${b.totalCharge? ' â€¢ â‚¹'+b.totalCharge : ''}</span></td>
							</tr>`;
						}).join('')}
					</tbody>
				</table>
			</div>

			<div class="panel">
				<h3 style="margin-top:0">Fleet Snapshot</h3>
				<div style="display:flex; flex-direction:column; gap:8px">
					${state.vehicles.map(v=>`<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:8px; background:rgba(16,32,24,0.02)">
						<div><strong>${v.reg}</strong><div class="tiny muted">${v.type} â€¢ ${v.make} ${v.model} â€¢ ${v.year}</div></div>
						<div style="text-align:right">
							<div class="tiny muted">Odo: ${v.odometer} km</div>
							<div class="tiny">Rate: â‚¹ ${v.ratePerDay}/day${v.perKmRate? ' â€¢ â‚¹'+v.perKmRate+'/km' : ''}</div>
							<div class="tiny">${v.insured? 'Insured â€¢ Exp: ' + (v.insuranceExpiry? new Date(v.insuranceExpiry).toLocaleDateString() : '-') : 'Not insured'}</div>
							<div class="tiny">${v.pollutionTested? 'Pollution OK â€¢ Exp: ' + (v.pollutionExpiry? new Date(v.pollutionExpiry).toLocaleDateString() : '-') : 'Pollution not tested'}</div>
						</div>
					</div>`).join('')}
				</div>
			</div>
		</div>
	`;
}

// VEHICLES
function renderVehicles(){
	filterInfo.textContent = 'Vehicles';
	const q = globalSearch.value.trim().toLowerCase();
	const rows = state.vehicles.filter(v => !q || v.reg.toLowerCase().includes(q) || (v.make+v.model).toLowerCase().includes(q) || (v.type||'').toLowerCase().includes(q));
	contentArea.innerHTML = `
		<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
			<h2 style="margin:0">Vehicles</h2>
			<div>
				<button class="btn ghost" id="exportVehicles">Export Vehicles</button>
				<button class="btn" id="newVehicle">+ Add Vehicle</button>
			</div>
		</div>
		<div class="panel">
			<table>
				<thead><tr><th>Registration</th><th>Type</th><th>Make / Model</th><th>Year</th><th>Odo</th><th>Rate/day</th><th>Per km</th><th>Docs</th><th>Actions</th></tr></thead>
				<tbody>
					${rows.map(v=>`<tr data-id="${v.id}">
						<td><strong>${v.reg}</strong></td>
						<td>${v.type || 'Car'}</td>
						<td>${v.make} ${v.model}</td>
						<td>${v.year}</td>
						<td>${v.odometer}</td>
						<td>â‚¹ ${v.ratePerDay}</td>
						<td>${v.perKmRate? 'â‚¹ '+v.perKmRate : '-'}</td>
						<td>
							<div class="doc-list">
								${v.photo? `<img class="thumb" src="${v.photo}" alt="photo">` : '<div class="doc-item">No photo</div>'}
							</div>
						</td>
						<td class="actions">
							<button class="btn ghost edit-vehicle" data-id="${v.id}">Edit</button>
							<button class="btn" style="background:#ff7b7b" data-id="${v.id}" onclick="deleteVehicle('${v.id}')">Delete</button>
						</td>
					</tr>`).join('')}
				</tbody>
			</table>
		</div>
	`;
	document.getElementById('newVehicle').onclick = openVehicleModal;
	document.getElementById('exportVehicles').onclick = ()=>exportCSV('vehicles');
	document.querySelectorAll('.edit-vehicle').forEach(b => b.addEventListener('click', e => openVehicleModal(e.target.dataset.id)));
}

function deleteVehicle(id){
	if(!confirm('Delete vehicle and its related bookings/maintenance?')) return;
	state.vehicles = state.vehicles.filter(v => v.id !== id);
	state.bookings = state.bookings.filter(b => b.vehicleId !== id);
	state.maintenance = state.maintenance.filter(m => m.vehicleId !== id);
	save();
	renderCurrent();
}

// VEHICLE MODAL (with type + photo + insurance + pollution)
function openVehicleModal(id=null){
	const v = state.vehicles.find(x=>x.id===id) || {reg:'', type:'Car', make:'', model:'', year:'', odometer:0, ratePerDay:0, perKmRate:0, notes:'', photo:null, insured:false, insuranceExpiry:null, pollutionTested:false, pollutionExpiry:null};
	
	// Use existing photo data for the initial data-url on the preview div
	const initialPhotoDataUrl = v.photo || '';

	showModal(`
		<h2>${id? 'Edit' : 'Add'} Vehicle</h2>
		<div class="modal-content">
			<div class="form-grid">
				<div class="form-row"><label>Registration</label><input id="v_reg" value="${escapeHtml(v.reg)}" /></div>

				<div class="form-row">
					<label>Type</label>
					<select id="v_type">
						<option value="Car" ${v.type==='Car' ? 'selected' : ''}>Car</option>
						<option value="Bike" ${v.type==='Bike' ? 'selected' : ''}>Bike</option>
					</select>
				</div>

				<div class="form-row"><label>Make</label><input id="v_make" value="${escapeHtml(v.make)}" /></div>
				<div class="form-row"><label>Model</label><input id="v_model" value="${escapeHtml(v.model)}" /></div>
				<div class="form-row"><label>Year</label><input id="v_year" value="${escapeHtml(v.year)}" /></div>
				<div class="form-row"><label>Odometer (km)</label><input id="v_odo" type="number" value="${v.odometer}" /></div>
				<div class="form-row"><label>Rate per day (â‚¹)</label><input id="v_rate" type="number" value="${v.ratePerDay}" /></div>
				<div class="form-row"><label>Per km rate (â‚¹)</label><input id="v_perkm" type="number" value="${v.perKmRate}" /></div>

				<div class="form-row">
					<label>Car/Bike Photo (jpg/png)</label>
					<input id="v_photo" type="file" accept="image/*" />
					<div id="v_photo_preview" style="margin-top:8px" data-data-url="${initialPhotoDataUrl}">
						${v.photo? `<img class="thumb" src="${v.photo}" />` : ''}
					</div>
				</div>

				<div class="form-row">
					<label><input id="v_insured" type="checkbox" ${v.insured? 'checked':''} /> Insured?</label>
				</div>
				<div class="form-row">
					<label>Insurance expiry (optional)</label>
					<input id="v_ins_exp" type="date" value="${v.insuranceExpiry? new Date(v.insuranceExpiry).toISOString().slice(0,10):''}" />
				</div>

				<div class="form-row">
					<label><input id="v_pollution" type="checkbox" ${v.pollutionTested? 'checked':''} /> Pollution tested?</label>
				</div>
				<div class="form-row">
					<label>Pollution expiry (optional)</label>
					<input id="v_poll_exp" type="date" value="${v.pollutionExpiry? new Date(v.pollutionExpiry).toISOString().slice(0,10):''}" />
				</div>

				<div style="grid-column:1/3" class="form-row"><label>Notes</label><textarea id="v_notes">${escapeHtml(v.notes||'')}</textarea></div>
			</div>
		</div>

		<div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px" id="modalFooterRow">
			<button class="btn ghost" id="cancelVehicle">Cancel</button>
			<button class="btn" id="saveVehicle">${id? 'Save' : 'Add'}</button>
		</div>
	`);

	// wire file inputs
	const photoInput = document.getElementById('v_photo');
	const photoPreview = document.getElementById('v_photo_preview');

	photoInput.addEventListener('change', async (e) => {
		const f = e.target.files[0];
		if(!f) return;
		const data = await fileToDataUrl(f);
		// Corrected: Update the innerHTML and the data-url attribute
		photoPreview.innerHTML = `<img class="thumb" src="${data}" />`;
		photoPreview.dataset.dataUrl = data; // Store it for saving later
	});
	

	document.getElementById('cancelVehicle').onclick = hideModal;
	document.getElementById('saveVehicle').onclick = ()=>{
		const reg = document.getElementById('v_reg').value.trim();
		if(!reg){ alert('Registration required'); return; }
		const payload = {
			reg,
			type: document.getElementById('v_type').value || 'Car',
			make: document.getElementById('v_make').value.trim(),
			model: document.getElementById('v_model').value.trim(),
			year: document.getElementById('v_year').value.trim(),
			odometer: Number(document.getElementById('v_odo').value) || 0,
			ratePerDay: Number(document.getElementById('v_rate').value) || 0,
			perKmRate: Number(document.getElementById('v_perkm').value) || 0,
			notes: document.getElementById('v_notes').value.trim(),
			// CRUCIAL FIX: Read the stored data-url (either new file or existing photo data)
			photo: photoPreview.dataset.dataUrl || null,	
			insured: document.getElementById('v_insured').checked,
			insuranceExpiry: document.getElementById('v_ins_exp').value ? new Date(document.getElementById('v_ins_exp').value).toISOString() : null,
			pollutionTested: document.getElementById('v_pollution').checked,
			pollutionExpiry: document.getElementById('v_poll_exp').value ? new Date(document.getElementById('v_poll_exp').value).toISOString() : null
		};
		if(id){
			const idx = state.vehicles.findIndex(x=>x.id===id);
			state.vehicles[idx] = {...state.vehicles[idx], ...payload};
		} else {
			state.vehicles.push({...payload, id: uid('v'), status:'available'});
		}
		save(); hideModal(); renderCurrent();
	};
}

// CUSTOMERS
function renderCustomers(){
	filterInfo.textContent = 'Customers';
	const q = globalSearch.value.trim().toLowerCase();
	const rows = state.customers.filter(c => !q || c.name.toLowerCase().includes(q) || (c.phone||'').includes(q));
	contentArea.innerHTML = `
		<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
			<h2 style="margin:0">Customers</h2>
			<div>
				<button class="btn" id="newCustomer">+ Add Customer</button>
			</div>
		</div>
		<div class="panel">
			<table>
				<thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Actions</th></tr></thead>
				<tbody>
					${rows.map(c=>`<tr data-id="${c.id}">
						<td>${c.name}</td>
						<td>${c.phone}</td>
						<td>${c.email||'-'}</td>
						<td class="actions">
							<button class="btn ghost edit-customer" data-id="${c.id}">Edit</button>
							<button class="btn" style="background:#ff7b7b" data-id="${c.id}" onclick="deleteCustomer('${c.id}')">Delete</button>
						</td>
					</tr>`).join('')}
				</tbody>
			</table>
		</div>
	`;
	document.getElementById('newCustomer').onclick = openCustomerModal;
	document.querySelectorAll('.edit-customer').forEach(b => b.addEventListener('click', e => openCustomerModal(e.target.dataset.id)));
}

function deleteCustomer(id){
	if(!confirm('Delete customer? Bookings will remain but customer record removed.')) return;
	state.customers = state.customers.filter(c=>c.id!==id);
	save(); renderCurrent();
}

function openCustomerModal(id=null){
	const c = state.customers.find(x=>x.id===id) || {name:'', phone:'', email:''};
	showModal(`
		<h2>${id? 'Edit' : 'Add'} Customer</h2>
		<div class="modal-content">
			<div class="form-grid">
				<div class="form-row"><label>Name</label><input id="c_name" value="${escapeHtml(c.name)}" /></div>
				<div class="form-row"><label>Phone</label><input id="c_phone" value="${escapeHtml(c.phone)}" /></div>
				<div class="form-row" style="grid-column:1/3"><label>Email</label><input id="c_email" value="${escapeHtml(c.email||'')}" /></div>
			</div>
		</div>
		<div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px" id="modalFooterRow">
			<button class="btn ghost" id="cancelCustomer">Cancel</button>
			<button class="btn" id="saveCustomer">${id? 'Save' : 'Add'}</button>
		</div>
	`);
	document.getElementById('cancelCustomer').onclick = hideModal;
	document.getElementById('saveCustomer').onclick = ()=>{
		const name = document.getElementById('c_name').value.trim();
		if(!name){ alert('Name required'); return; }
		const payload = { name, phone: document.getElementById('c_phone').value.trim(), email: document.getElementById('c_email').value.trim() };
		if(id){
			const idx = state.customers.findIndex(x=>x.id===id);
			state.customers[idx] = {...state.customers[idx], ...payload};
		} else {
			state.customers.push({...payload, id: uid('c')});
		}
		save(); hideModal(); renderCurrent();
	};
}

// BOOKINGS
function renderBookings(){
	filterInfo.textContent = 'Bookings';
	const q = globalSearch.value.trim().toLowerCase();
	const rows = state.bookings.filter(b => {
		const v = state.vehicles.find(x=>x.id===b.vehicleId) || {};
		const c = state.customers.find(x=>x.id===b.customerId) || {};
		return !q || (v.reg && v.reg.toLowerCase().includes(q)) || (c.name && c.name.toLowerCase().includes(q));
	});

	contentArea.innerHTML = `
		<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
			<h2 style="margin:0">Bookings</h2>
			<div>
				<button class="btn" id="newBooking">+ Create Booking</button>
			</div>
		</div>

		<div class="panel">
			<table>
				<thead><tr><th>Vehicle</th><th>Customer</th><th>From</th><th>To</th><th>Status</th><th>Driver?</th><th>Charge</th><th>Actions</th></tr></thead>
				<tbody>
					${rows.slice().sort((a,b)=>new Date(a.start)-new Date(b.start)).map(b=> {
						const v = state.vehicles.find(x=>x.id===b.vehicleId)||{};
						const c = state.customers.find(x=>x.id===b.customerId)||{};
						return `<tr>
							<td><strong>${v.reg||'â€”'}</strong><div class="tiny muted">${v.type||''} â€¢ ${v.make||''} ${v.model||''}</div></td>
							<td>${c.name||'â€”'}<div class="tiny muted">${c.phone||''}</div></td>
							<td>${fmt(b.start)}</td>
							<td>${fmt(b.end)}</td>
							<td><span class="badge">${b.status}</span></td>
							<td>${b.needsDriver? '<span class="pill">Yes</span>' : '<span class="tiny muted">No</span>'}</td>
							<td>${b.totalCharge? 'â‚¹ '+b.totalCharge : 'â€”'}</td>
							<td class="actions">
								${b.status === 'booked' ? `<button class="btn" onclick="startBooking('${b.id}')">Start</button>` : ''}
								${b.status === 'active' ? `<button class="btn" onclick="returnBooking('${b.id}')">Return</button>` : ''}
								${b.status !== 'completed' && b.status !== 'cancelled' ? `<button class="btn ghost" onclick="openBookingModal('${b.id}')">Edit</button>
								<button class="btn" style="background:#ff7b7b" onclick="cancelBooking('${b.id}')">Cancel</button>` : ''}
							</td>
						</tr>`;
					}).join('')}
				</tbody>
			</table>
		</div>
	`;
	document.getElementById('newBooking').onclick = ()=>openBookingModal();
}

/*
	booking modal now includes:
	- vehicleTypePref: Any/Car/Bike
	- vehicle select will be filtered to match the preference
*/
function openBookingModal(id=null){
	const b = state.bookings.find(x=>x.id===id) || {customerId:'', vehicleId:'', vehicleTypePref:'Any', start:'', end:'', startOdometer:null, endOdometer:null, purpose:'', status:'booked', totalCharge:null, needsDriver:false};
	const vehicleOptionsAll = state.vehicles.map(v=>`<option value="${v.id}" data-type="${v.type||'Car'}" ${v.id===b.vehicleId? 'selected':''}>${v.reg} â€” ${v.type || 'Car'} â€” ${v.make} ${v.model} â€” â‚¹${v.ratePerDay}/day</option>`).join('');
	const customerOptions = state.customers.map(c=>`<option value="${c.id}" ${c.id===b.customerId? 'selected':''}>${c.name} â€” ${c.phone}</option>`).join('');

	showModal(`
		<h2>${id? 'Edit' : 'New'} Booking</h2>
		<div class="modal-content">
			<div class="form-grid">
				<div class="form-row"><label>Customer</label><select id="bk_customer"><option value="">-- select --</option>${customerOptions}</select></div>

				<div class="form-row">
					<label>Vehicle type preference</label>
					<select id="bk_vehicle_type_pref">
						<option value="Any" ${b.vehicleTypePref==='Any'?'selected':''}>Any</option>
						<option value="Car" ${b.vehicleTypePref==='Car'?'selected':''}>Car</option>
						<option value="Bike" ${b.vehicleTypePref==='Bike'?'selected':''}>Bike</option>
					</select>
				</div>

				<div class="form-row"><label>Vehicle</label><select id="bk_vehicle"><option value="">-- select --</option>${vehicleOptionsAll}</select></div>

				<div class="form-row"><label>Start (date & time)</label><input id="bk_start" type="datetime-local" value="${b.start? new Date(b.start).toISOString().slice(0,16):''}" /></div>
				<div class="form-row"><label>End (date & time)</label><input id="bk_end" type="datetime-local" value="${b.end? new Date(b.end).toISOString().slice(0,16):''}" /></div>
				<div class="form-row"><label>Start odometer</label><input id="bk_startodo" type="number" value="${b.startOdometer || ''}" /></div>
				<div class="form-row"><label>Needs driver?</label><input id="bk_driver" type="checkbox" ${b.needsDriver? 'checked':''} /></div>
				<div style="grid-column:1/3" class="form-row"><label>Purpose</label><input id="bk_purpose" value="${escapeHtml(b.purpose||'')}" /></div>
			</div>
		</div>

		<div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px" id="modalFooterRow">
			<button class="btn ghost" id="bk_cancel">Cancel</button>
			<button class="btn" id="bk_save">${id? 'Save' : 'Create'}</button>
		</div>
	`);

	// After modal created, wire filter behavior for vehicle type preference
	const vehicleSelect = document.getElementById('bk_vehicle');
	const typePref = document.getElementById('bk_vehicle_type_pref');

	function filterVehiclesByType(){
		const pref = typePref.value;
		// store selected id
		const sel = vehicleSelect.value;
		// reconstruct options based on pref
		vehicleSelect.innerHTML = '<option value="">-- select --</option>' + state.vehicles.filter(v=>{
			if(pref === 'Any') return true;
			return (v.type || 'Car') === pref;
		}).map(v=>`<option value="${v.id}" ${v.id===sel? 'selected':''}>${v.reg} â€” ${v.type||'Car'} â€” ${v.make} ${v.model} â€” â‚¹${v.ratePerDay}/day</option>`).join('');
	}

	// initial filter by existing preference (if editing)
	filterVehiclesByType();

	// wire change event to filter vehicles
	typePref.addEventListener('change', filterVehiclesByType);

	document.getElementById('bk_cancel').onclick = hideModal;
	document.getElementById('bk_save').onclick = ()=>{
		const customerId = document.getElementById('bk_customer').value;
		const vehicleId = document.getElementById('bk_vehicle').value;
		const start = document.getElementById('bk_start').value;
		const end = document.getElementById('bk_end').value;
		const startOdo = Number(document.getElementById('bk_startodo').value) || null;
		const needsDriver = document.getElementById('bk_driver').checked;
		const vehicleTypePref = document.getElementById('bk_vehicle_type_pref').value || 'Any';
		if(!customerId || !vehicleId || !start || !end){ alert('Customer, vehicle, start and end are required'); return; }
		if(new Date(start) >= new Date(end)){ alert('End must be after start'); return; }
		if(!isVehicleAvailable(vehicleId, start, end, id)){ alert('Vehicle not available at that time'); return; }
		if(id){
			const idx = state.bookings.findIndex(x=>x.id===id);
			state.bookings[idx] = {...state.bookings[idx], customerId, vehicleId, vehicleTypePref, start:new Date(start).toISOString(), end:new Date(end).toISOString(), startOdometer: startOdo, purpose: document.getElementById('bk_purpose').value.trim(), needsDriver};
		} else {
			state.bookings.push({id:uid('b'), customerId, vehicleId, vehicleTypePref, start:new Date(start).toISOString(), end:new Date(end).toISOString(), startOdometer: startOdo, endOdometer:null, purpose:document.getElementById('bk_purpose').value.trim(), status:'booked', createdAt:new Date().toISOString(), totalCharge:null, needsDriver});
		}
		save(); hideModal(); renderCurrent();
	};
}

function isVehicleAvailable(vehicleId, start, end, excludeId=null){
	const s = new Date(start); const e = new Date(end);
	return !state.bookings.some(b => {
		if(b.vehicleId !== vehicleId) return false;
		if(excludeId && b.id === excludeId) return false;
		if(b.status === 'cancelled' || b.status === 'completed') return false;
		const bs = new Date(b.start), be = new Date(b.end);
		return (s < be && e > bs); // overlap
	});
}

function startBooking(id){
	const idx = state.bookings.findIndex(b=>b.id===id);
	if(idx===-1) return;
	const b = state.bookings[idx];
	const v = state.vehicles.find(x=>x.id===b.vehicleId);
	if(!v){ alert('Vehicle missing'); return; }
	b.actualStart = new Date().toISOString();
	if(!b.startOdometer) b.startOdometer = v.odometer || 0;
	b.status = 'active';
	v.status = 'rented';
	save(); renderCurrent();
}

function returnBooking(id){
	const idx = state.bookings.findIndex(b=>b.id===id);
	if(idx===-1) return;
	const b = state.bookings[idx];
	const v = state.vehicles.find(x=>x.id===b.vehicleId);
	if(!v){ alert('Vehicle missing'); return; }
	// prompt for odometer and return time
	const retTimeStr = prompt('Enter return date & time (YYYY-MM-DDTHH:MM) or leave blank for now:', new Date().toISOString().slice(0,16));
	if(retTimeStr === null) return;
	const retOdoStr = prompt('Enter odometer at return (km):', v.odometer || (b.startOdometer||0));
	if(retOdoStr === null) return;
	const retTime = new Date(retTimeStr);
	if(isNaN(retTime.getTime())){ alert('Invalid date/time'); return; }
	const retOdo = Number(retOdoStr);
	if(isNaN(retOdo)){ alert('Invalid odometer'); return; }

	const startTime = b.actualStart ? new Date(b.actualStart) : new Date(b.start);
	const days = ceilDays(startTime, retTime);
	const kmUsed = retOdo - (b.startOdometer || 0);
	const base = clamp(v.ratePerDay) * days;
	const kmCharge = (clamp(v.perKmRate) && kmUsed>0) ? clamp(v.perKmRate) * kmUsed : 0;
	const total = Math.round((base + kmCharge) * 100) / 100;

	b.endOdometer = retOdo;
	b.actualEnd = retTime.toISOString();
	b.totalCharge = total;
	b.status = 'completed';
	v.status = 'available';
	v.odometer = retOdo;
	save();
	alert(`Return processed\nDays charged: ${days}\nKM used: ${kmUsed}\nTotal: â‚¹ ${total}`);
	renderCurrent();
}

function cancelBooking(id){
	if(!confirm('Cancel booking?')) return;
	const idx = state.bookings.findIndex(b=>b.id===id);
	if(idx!==-1){ state.bookings[idx].status = 'cancelled'; save(); renderCurrent(); }
}

// MAINTENANCE
function renderMaintenance(){
	filterInfo.textContent = 'Maintenance';
	contentArea.innerHTML = `
		<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
			<h2 style="margin:0">Maintenance</h2>
			<div>
				<button class="btn" id="newMaint">Log Maintenance</button>
			</div>
		</div>
		<div class="panel">
			<table>
				<thead><tr><th>Vehicle</th><th>Date</th><th>Type</th><th>Vendor</th><th>Cost</th><th>Notes</th></tr></thead>
				<tbody>
					${state.maintenance.map(m=>{
						const v = state.vehicles.find(x=>x.id===m.vehicleId)||{};
						return `<tr>
							<td>${v.reg || 'â€”'}</td>
							<td>${fmt(m.date)}</td>
							<td>${m.type}</td>
							<td>${m.vendor}</td>
							<td>â‚¹ ${m.cost || 0}</td>
							<td>${m.notes || ''}</td>
						</tr>`;
					}).join('')}
				</tbody>
			</table>
		</div>
	`;
	document.getElementById('newMaint').onclick = openMaintenanceModal;
}

function openMaintenanceModal(){
	const vehicleOptions = state.vehicles.map(v=>`<option value="${v.id}">${v.reg} â€” ${v.make} ${v.model}</option>`).join('');
	showModal(`
		<h2>Log Maintenance</h2>
		<div class="modal-content">
			<div class="form-grid">
				<div class="form-row"><label>Vehicle</label><select id="m_vehicle"><option value="">-- select --</option>${vehicleOptions}</select></div>
				<div class="form-row"><label>Date</label><input id="m_date" type="date" value="${new Date().toISOString().slice(0,10)}" /></div>
				<div class="form-row"><label>Type</label><input id="m_type" /></div>
				<div class="form-row"><label>Vendor</label><input id="m_vendor" /></div>
				<div class="form-row"><label>Cost</label><input id="m_cost" type="number" /></div>
				<div style="grid-column:1/3" class="form-row"><label>Notes</label><textarea id="m_notes"></textarea></div>
			</div>
		</div>
		<div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px" id="modalFooterRow">
			<button class="btn ghost" id="m_cancel">Cancel</button>
			<button class="btn" id="m_save">Save</button>
		</div>
	`);
	document.getElementById('m_cancel').onclick = hideModal;
	document.getElementById('m_save').onclick = ()=>{
		const vehicleId = document.getElementById('m_vehicle').value;
		const date = document.getElementById('m_date').value;
		const type = document.getElementById('m_type').value.trim();
		if(!vehicleId || !date || !type){ alert('Vehicle, date and type are required'); return; }
		state.maintenance.push({id: uid('m'), vehicleId, date: new Date(date).toISOString(), type, vendor: document.getElementById('m_vendor').value.trim(), cost: Number(document.getElementById('m_cost').value) || 0, notes: document.getElementById('m_notes').value.trim()});
		save(); hideModal(); renderCurrent();
	};
}

// ---------- modal helpers (new robust version) ----------
function showModal(html){
	modalRoot.style.display = 'block';
	modalRoot.innerHTML = `
		<div class="modal-backdrop" id="mb">
			<div class="modal" role="dialog" aria-modal="true">
				<div class="modal-body"></div>
			</div>
		</div>
	`;
	// close on backdrop click
	document.getElementById('mb').addEventListener('click', (e)=>{ if(e.target.id === 'mb') hideModal(); });

	// insert html inside modal-body
	const modalBody = modalRoot.querySelector('.modal-body');
	modalBody.innerHTML = html;

	// Try to locate footer candidate inside the inserted HTML.
	// 1) explicit .modal-footer element -> move it
	let footerCandidate = modalBody.querySelector('.modal-footer');

	if(!footerCandidate){
		// 2) fallback: look for the last child div that uses inline style with justify-content:flex-end (our templates use this)
		const divs = Array.from(modalBody.querySelectorAll('div'));
		footerCandidate = divs.reverse().find(d => {
			const s = d.getAttribute('style') || '';
			return /justify-content\s*:\s*flex-end/.test(s);
		});
	}

	if(footerCandidate){
		// convert to proper modal-footer and move it outside modal-body
		footerCandidate.classList.add('modal-footer');
		footerCandidate.removeAttribute('style');
		const modalEl = modalRoot.querySelector('.modal');
		modalEl.appendChild(footerCandidate);
	}
}

function hideModal(){ modalRoot.style.display = 'none'; modalRoot.innerHTML = ''; }

// ---------- file helper ----------
function fileToDataUrl(file){
	return new Promise((resolve, reject) => {
		const reader = new FileReader();
		reader.onload = () => resolve(reader.result);
		reader.onerror = reject;
		reader.readAsDataURL(file);
	});
}

// ---------- CSV export ----------
function exportCSV(scope='all'){
	function toCSV(rows, headers){
		const esc = v => `"${String(v||'').replace(/"/g,'""')}"`;
		const lines = [headers.map(esc).join(',')];
		rows.forEach(r => lines.push(headers.map(h=>getField(r,h)).join(',')));
		return lines.join('\n');	
	}
	function getField(r,h){ return r[h] !== undefined ? r[h] : ''; }
	const parts = [];
	if(scope==='all' || scope==='vehicles'){
		parts.push('--- Vehicles');
		const vehRows = state.vehicles.map(v => ({
			id:v.id, reg:v.reg, type:v.type, make:v.make, model:v.model, year:v.year, odometer:v.odometer,
			ratePerDay:v.ratePerDay, perKmRate:v.perKmRate, status:v.status, notes:v.notes,
			hasPhoto: v.photo ? 'yes' : 'no',
			insured: v.insured ? 'yes' : 'no',
			insuranceExpiry: v.insuranceExpiry || '',
			pollutionTested: v.pollutionTested ? 'yes' : 'no',
			pollutionExpiry: v.pollutionExpiry || ''
		}));
		parts.push(toCSV(vehRows, ['id','reg','type','make','model','year','odometer','ratePerDay','perKmRate','status','notes','hasPhoto','insured','insuranceExpiry','pollutionTested','pollutionExpiry']));
	}
	if(scope==='all' || scope==='customers'){
		parts.push('--- Customers');
		parts.push(toCSV(state.customers, ['id','name','phone','email']));
	}
	if(scope==='all' || scope==='bookings'){
		parts.push('--- Bookings');
		parts.push(toCSV(state.bookings, ['id','customerId','vehicleId','start','end','actualStart','actualEnd','startOdometer','endOdometer','status','totalCharge','purpose','createdAt','needsDriver','vehicleTypePref']));
	}
	if(scope==='all' || scope==='maintenance'){
		parts.push('--- Maintenance');
		parts.push(toCSV(state.maintenance, ['id','vehicleId','date','type','vendor','cost','notes']));
	}
	const blob = new Blob([parts.join('\n\n')], {type:'text/csv'});	
	const url = URL.createObjectURL(blob);
	const a = document.createElement('a'); a.href=url; a.download = 'vrs_export.csv'; a.click();
	URL.revokeObjectURL(url);
}

// ðŸ”‘ NEW FUNCTION: Goes back to the previous page using browser history
function goBack() {
    window.history.back();
}


// ---------- init ----------
load();	
// The photo property already exists and is initialized in seed, no further migration needed.
seed();	
renderCurrent();

// helper to escape html for inputs
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ---------- global helpers (for inline handlers) ----------
window.openBookingModal = openBookingModal;
window.deleteVehicle = deleteVehicle;
window.deleteCustomer = deleteCustomer;
window.startBooking = startBooking;
window.returnBooking = returnBooking;
window.cancelBooking = cancelBooking;
window.exportCSV = exportCSV;
window.goBack = goBack; // ðŸ‘ˆ Registered for use by the button's onclick
</script>
</body>
</html>